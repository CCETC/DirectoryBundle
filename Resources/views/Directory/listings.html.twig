{% extends layoutTemplate %}

{% block page_header %}
    {{ 'Listings'|trans({}, "messages") }}
{% endblock %}

{% block content %}
    <script type="text/javascript">
        var listingMapData = new Object;

        {% for listing in listings if listing.lat is defined and listing.lat != "" and listing.lng is defined and listing.lng != "" %}
            {% include 'CCETCDirectoryBundle:Directory:_listing_object.js.twig' %}
            listingMapData["{{listing.id}}"] = listing;
        {% endfor %}            

        var map;

        $(document).ready(function() {
            listingsMapInit();
        });    
    </script>
    
    {% if searchTerms is  defined and searchTerms != "" %}
        <div class="row">
            <div class="span12">
                <div class="alert alert-block alert-success">
                    <h4>Search for <i>{{ searchTerms }}</i> returned {{ listings|length }} result{{ listings|length == 1? '' : 's' }}.</h4><br/>
                    <a href="{{ path('listings') }}" class="btn"><i class="icon-remove"></i> Clear Search</a>
                </div>
            </div>
        </div>        
    {% else %}
        <div class="row">
            <div class="span12">
                <form action="{{ url('listings') }}" method="GET">
                    <h2>Active Filters</h2>
                    {% for filter in listingAdmin.datagrid.filters if filter.isActive %}
                        <div class="filter">
                            <div class="filter-title">{{ listingAdmin.trans(filter.label) }}</div>
                            <div class="filter-type">{{ form_widget(form.children[filter.formName].children['type']) }}</div>
                            <div class="filter-value">{{ form_widget(form.children[filter.formName].children['value']) }}</div>
                            <div style="clear: both; line-height: 0px;">&nbsp;</div>
                        </div>
                    {% endfor %}
                    <h2>Inactive Filters</h2>
                    {% for filter in listingAdmin.datagrid.filters if not filter.isActive %}
                        <div class="filter">
                            {% if filter.getFieldOptions.expanded is defined %}
                                {% for test in filter.getAssociationMapping %}
                                {% endfor %}
                            {% endif %}
                            <div class="filter-title">{{ listingAdmin.trans(filter.label) }}</div>
                            <div class="filter-type" style="{{ filter.name is defined and filter.name == 'location' ? 'f' : 'display: none;' }}">
                                {% if filter.name is defined and filter.name == 'location' %}
                                    Within
                                {% endif %}
                                {{ form_widget(form.children[filter.formName].children['type']) }}
                            </div>
                            <div class="filter-value">
                                {% if filter.name is defined and filter.name == 'location' %}
                                    miles of
                                {% endif %}
                                {{ form_widget(form.children[filter.formName].children['value']) }}
                            </div>
                            <div style="clear: both; line-height: 0px;">&nbsp;</div>
                        </div>
                    {% endfor %}                        

                    <input type="hidden" name="filter[_page]" id="filter__page" value="1" />

                    {% set foo = form.children['_page'].setRendered() %}
                    {{ form_rest(form) }}

                    <input type="submit" class="btn btn-primary" value="Update" />

                    <a class="btn" href="{{ url('listings', {filters: 'reset'}) }}">Clear</a>
                </form>
            </div>
        </div>
    {% endif %}
    
    <div class="row">
        {% if listings|length > 0 %}
            <div class="span7">
                {% for listing in listings %}
                    {% include 'CCETCDirectoryBundle:Directory:_listing_block.html.twig' with {'listing' : listing } %}
                {% endfor %}
            </div>
            <div class="span5">
                <div id="map-canvas" class="listings-map"></div>
            </div>
        {% elseif searchTerms is not defined or searchTerms == "" %}
            <div class="span12">
                <div class="alert alert-block">
                    <h4>We couldn't find any listings! Try expanding your Search</h4>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}